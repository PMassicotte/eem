---
title: "Creating custom import functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating your custom import function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eemR)
```

## Motivations

When `eemR` was originally created, I wrote few functions to import eems derived from the spectrofluorometers I knew. After a while, I found it was not possible to write a custom function that was able to automatically read and import eems generated from the software of each spectrofluorometer. In this new version of `eemR` there is now the possibility for the user to write his/her own import function.

## An example

In this example, we will learn how to create a import function for a specific eem file generated by the software of a Cary Eclipse spectrofluorometer. First, lets have a look to the content of `custom_cary.csv`.

```{r, comment=""}
file <- system.file("extdata/custom_cary.csv", package = "eemR")

cat(readLines(file, n = 25), sep = "\n")
```

From this output, we see that:

1. The emission wavelengths are contained in the first column (250, 252, ...).
2. The excitation wavelengths are in the first row (50, 55, ...).
3. The fluorescence data start at row 3 and column 2.

The first thing we need to do is to create a function that will read this data in a format that can be used by `eemR`. **The function needs to meet these flowing criteria:**

1. Have an argument `file` that will contains the path of the file(s) to read.
2. Return a list containing the flowing elements:
    - `file`: the path of the file
    - `em`: a numeric vector containing emission wavelengths.
    - `ex`: a numeric vector containing excitation wavelengths.
    - `x`: a matrix of `length(em)` rows by `length(ex)` columns.

Further more, the `x` element of the list need to be arranged as follow:

![](matrix.png)

Let's now write a function that will read the eem file and format the data accordingly.

```{r}
import_cary <- function(file) {
  dat <- read.csv(file, nrows = 102, skip = 1)

  ex <- na.omit(dat[, 1])
  em <- seq(50, 330, by = 5) + 250 #TODO: Something wrong with these emission wavelengths

  x <- dat[, -1]
  x <- x[-1, ]
  x <- matrix(as.numeric(unlist(x, use.names = FALSE)), ncol = length(ex), byrow = TRUE)

  # Return a list with the four components
  l <- list(
    file = file,
    x = x,
    ex = ex,
    em = em
  )
  
  return(l)
}
```

We can now try our function. We see that this is simply a list containing the four elements mentionned before.

```{r}
str(import_cary(file))
```


We will use the `import_function` argument of the `eem_read()` function to tell `eemR` how to read our file.

```{r}
eem <- eem_read(file, import_function = import_cary)

eem
```

We can visualize the eem by using the `plot()` function:

```{r, fig.width=8, fig.height=6}
plot(eem)
```

All other functions of the `eemR` package can now be used on the created `eem`. For example, we can remove the second order scattering.

```{r}
plot(eem_remove_scattering(eem, "rayleigh", order = 2))
```

