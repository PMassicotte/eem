---
title: "Working with PARAFAC results"
author: "Philippe Massicotte"
date: "`r Sys.Date()`"
bibliography: biblio.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{parafac}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

The [drEEM](http://www.models.life.ku.dk/dreem) MATLAB toolbox [@Murphy2013] offers a convenient way to create PARAFAC models. However, one might be interested to export PARAFAC result for further processing in R such as graphics or statistical analysis. The `eemR` package offers some functions to import PARAFAC models generated by `drEEM` into R.

## Exporting PARAFAC models from MATLAB

This tutorial assumes that you are already familiar with the `drEEM` toolbox. If you are not, I suggest you to read this [excellent tutorial](http://www.models.life.ku.dk/sites/default/files/drEEM%20_010_webversion.pdf). Here I am going to pretend that `Test1` is your final model that has been validated.

```matlab
Test1 = OutlierTest(OriginalData, 1, 1, 7, 'Yes', 'No');
```

Once you are happy with your model, you should export it into a `matfile`. From MATLAB, this can be done as follow:

```matlab
save('your/path/model.mat', 'Test1');
```

This will create a `matfile` named `model.mat` which will contain the `Test1` PARAFAC model.

## Importing PARAFC models

Importing a MATLAB PARAFAC model into R is done using the `eem_read_parafac(path)` function where `path`. The function is assuming that the PARAFAC model has been saved as described earlier. For convenience, a simple PARAFAC model is provided in the package which can be read as follow.

```{r}
library(eemR)

# Mat file containing the PARAFAC model
f <- system.file("extdata/parafac_model.mat", package = "eemR")

# Read the PARAFAC model that contains "mymodel". We also specify that we want the model with 4 components
m <- eem_read_parafac(f, object = "mymodel", ncomp = 4)
```

The object `m` is simply a list of class `parafac_model` which contains two data frames. The first one is named `loading` and contains loading information needed to produce the model component plot. The second data fram is named `fmax` and contains FMax information for each sample for all the PARAFAC components.

```{r}
str(m)
```

> The PARAFAC model loadings obtained using the N-way toolbox are normalised so that all quantitative information is contained in the model scores (“a” in eqn (1)). Fmax is calculated by multiplying the maximum excitation loading and maximum emission loading for each component by its score, producing intensities in the same measurement scale as the original EEMs. Because different fluorophores can have very different efficiencies at absorbing and converting incident radiation to fluorescence, if component A has a higher fluorescence signal than component B it does not follow that A has a higher concentration than B. Quantitative and qualitative information may however be obtained from changes in the intensity of a given component, or in the ratios of any two components, between samples in the dataset. Also, changes in the relative abundance of a component (Fmax/∑Fmax) can indicate changes in its overall importance, although this measure is sensitive to changes in the relative abundances of all the components so must be interpreted with care [@Murphy2013].

## Plotting a PARAFAC model

Plotting a PARAFAC model is done using the `ggplot2` package using the generic `plot()` function.

```{r, fig.width = 8, fig.height = 4, fig.align = "center"}
p <- plot(m, ncol = 2, nrow = 2)
p
```

## References
